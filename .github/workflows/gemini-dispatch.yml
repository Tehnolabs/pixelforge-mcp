name: Gemini Dispatch

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  dispatch:
    # Trigger on "/gemini-review" from trusted users
    if: |-
      github.event.sender.type == 'User' &&
      startsWith(github.event.comment.body, '/gemini-review') &&
      contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    outputs:
      command: ${{ steps.extract_command.outputs.command }}
      additional_context: ${{ steps.extract_command.outputs.additional_context }}
      issue_number: ${{ github.event.pull_request.number || github.event.issue.number }}
    steps:
      # Note: github.event.comment.body is passed via env (safe pattern)
      # and processed in JS (not shell), preventing command injection.
      - name: Extract command
        id: extract_command
        uses: actions/github-script@v7
        env:
          REQUEST: ${{ github.event.comment.body }}
        with:
          script: |
            const request = process.env.REQUEST;

            if (request.startsWith('/gemini-review')) {
              core.setOutput('command', 'review');
              const ctx = request.replace(/^\/gemini-review/, '').trim();
              core.setOutput('additional_context', ctx);
            } else {
              core.setOutput('command', 'fallthrough');
            }

      - name: React with eyes to acknowledge
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes',
            });

  review:
    needs: dispatch
    if: needs.dispatch.outputs.command == 'review'
    uses: ./.github/workflows/gemini-review.yml
    permissions:
      contents: read
      issues: write
      pull-requests: write
    with:
      additional_context: ${{ needs.dispatch.outputs.additional_context }}
    secrets: inherit

  complete:
    needs:
      - dispatch
      - review
    if: success()
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: React with check mark on completion
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '+1',
            });

  fallthrough:
    needs:
      - dispatch
      - review
    if: |-
      always() && !cancelled() && (failure() || needs.dispatch.outputs.command == 'fallthrough')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: React with confused on failure
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'confused',
            });
      - name: Send failure comment
        env:
          GITHUB_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
          REPOSITORY: ${{ github.repository }}
        run: |
          gh issue comment "${ISSUE_NUMBER}" \
            --body "Sorry, I couldn't process that request." \
            --repo "${REPOSITORY}"
